---
output: html_document
editor_options: 
  chunk_output_type: console
---
output: html_document
editor_options: 
  chunk_output_type: console
---

#Superfile

These scripts allow you to create the data outputs needed for the Superfile creation. Since the data processing is different we will create a septerate workflow. This file does not need updated every year, but perhaps every 5-10 years as migration timings shift due to climate change, foe example. 


# Set up Station Data {#Setup3}

```{r tidyr3, echo = FALSE, message = FALSE, warning = FALSE}

library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=50), tidy = FALSE)

```

##Setup

The setup files will get you ready for your analysis. It loads you libraries, needed tables, created directories for your outputs, and assigns some parameter values. 

Also assign max year of the analysis. Generally, the data in NatureCounts are 2 years behind. 

```{r setup}

max.year <- 2021 #needs changes with each analysis
min.year <- 2000 #how far back do you want the data to go. 

```

## Choose your CMMN station {#Setup3.1}

The number assigned to `t` will correspond to the row in the analysis parameters file ('anal.param') you want to analyze (each site has a separate row).

View the file to identify the row you want to select
```{r view}

#This will need checked and updated before each analysis
anal.param <- read.csv("Data/CMMN_Analysis_ParameterValues.csv") 
View(anal.param)

```

##Select your station, or all stations in the analysis file if you wish to run a loop. 

**We may also choose to create a loop that runs through each stations and processes the data for the superfile analysis**
```{r chooseSite}

#Select a single site based on row number in anal.param
t <- 2 #test BBO

```

## Data manipulations {#Setup3.2}

Now that you have selected the CMMN site, we are going to clean the data. The cleaning scripts do the following: 

  - Load the data from the naturecounts database. You will be prompted for your password.
  - Assigns seasons (spring and fall)
  - Calculate season-specific station windows (when a station normally operates).
  - Make list of sampling dates for zero-filling.
  - Assign Species Code, and drop species that won't be analyzed (i.e., updates to taxonomies).
  - Assign UNEM For LPBO data only.
  - Save the manipulated data in the `Data` folder
  - Generates a species list for the analysis

This main differences from the analytically workflow `03-LoadManipSite` is that we are not using the superfile to filter to species and season of interest. We have also manually assigned the min and max year filters. 
  
First, assign 'u' your NatureCounts username and run the `prepare` scripts.

```{r data manip}
  
u<-"dethier"  #enter you NatureCounts ID
source("a_prepare.R")

```

## Data Summary

We are now ready to create our data summaries.  

  - Loop through each species in the `species.list` which was create in the last step.
  - Zero-fill the data frame using the `event.data` 
  - Drop any species from further analysis that falls below analysis thresholds for either criterion.
      Seasons where mean number of individuals/year is < 10 *based on DET*
      Seasons where mean number of observation days/year is < 5 *based on DET*
  - Calculate the mean count per doy for each response variable in each season, where
  
    ObservationCount = DET
    ObservationCount3 = census
    ObservationCount4 = banding
    ObservationCount7 = census + banding
    
  - Across all years, count up N of years for which each Day-of-year (doy) has a *DET* recorded.
  -	Calculate % of all years with data for that doy *based on DET*


```{r Change Defaults}

source("b_analysis.R")

```

## Classification Plots

    
-	Pick the doy at which % rises above 67%.  (Usually this is clear, but the odd day earlier may meet criterion, and vice versa, so some judgement needed.)

-	For each half-year, plot mean daily N vs. doy.  If possible, add a marker to graph showing start and end of coverage period. (Don’t have to be beautiful; just label with spp name and season. (Including the period before and after coverage period is helpful for assessing whether spp is present all summer or in winter.)

-	Examine plots to classify.  (Having done so much of this, I can do it quite quickly and with considerable confidence, so I’d be happy to take on this part if you could produce the graphs.)


```{r plot}

source("c_plot.R")

```
